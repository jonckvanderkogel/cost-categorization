<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Categorized Line Items</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.bundle.min.js" integrity="sha512-SuxO9djzjML6b9w9/I07IWnLnQhgyYVSpHZx0JV97kGBfTIsUYlWflyuW4ypnvhBrslz1yJ3R+S14fdCWmSmSA==" crossorigin="anonymous"></script>
  <script language="javascript" type="text/javascript">
  let wsUri = "ws://localhost:8080/websocket";
  let output;
  let websocket;
  let categorizedData = [];
  let goingToRender = false;

  function init() {
    output = document.getElementById("output");
    initWebSocket();
  }

  // from here: https://stackoverflow.com/a/57051556/718849
  const groupBy = (arr, key) =>
    arr.reduce(
            (r, v, _, __, k = v[key]) => ((r[k] || (r[k] = [])).push(v), r),
            {}
    );

  function initWebSocket() {
    websocket = new WebSocket(wsUri);
    websocket.onopen = function(evt) { onOpen(evt) };
    websocket.onclose = function(evt) { onClose(evt) };
    websocket.onmessage = function(evt) { onMessage(evt) };
    websocket.onerror = function(evt) { onError(evt) };
  }

  function onOpen(evt) {
    console.log("CONNECTED");
    doSend("Connect Websocket");
  }

  function onClose(evt) {
    console.log("DISCONNECTED");
  }

  function onMessage(evt) {
    categorizedData.push(JSON.parse(evt.data));
    if (!goingToRender) {
      goingToRender = true;
      setTimeout(createCharts, 1500);
    }
  }

  function createCharts() {
    let af = categorizedData.filter(li => li['transactionType'] === "AF");
    let bij = categorizedData.filter(li => li['transactionType'] === "BIJ");

    goingToRender = false;
    drawChart(af, "Af");
    drawChart(bij, "Bij");
  }

  const backgroundColors =  ["#5da5da", "#faa43a", "#60bd68", "#f17cb0", "#b2912f", "#b276b2", "#3e95cd", "#8e5ea2","#3cba9f","#e8c3b9","#c45850"]

  function drawChart(data, label) {
    let grouped = groupBy(data, 'category');
    let categories = Object.keys(grouped);
    let values = categories
            .map(key => grouped[key])
            .map(group => group.reduce((a, c) => a + c.amount, 0));
    let total = values.reduce((a, c) => a + c, 0);

    let totalFormatted = (Math.round(total * 100) / 100).toFixed(2);
    let valuesFormatted = values
            .map(num => (Math.round(num * 100) / 100).toFixed(2));
    let thisChartBackgroundColors = backgroundColors.slice(0, values.length - 1);

    let canvas = document.createElement('canvas');
    canvas.id = uuidv4();
    canvas.width = 400;
    canvas.height = 100;
    document.body.appendChild(canvas);

    new Chart(canvas, {
      type: 'pie',
      data: {
        labels: categories,
        datasets: [{
          backgroundColor: thisChartBackgroundColors,
          data: valuesFormatted
        }]
      },
      options: {
        title: {
          display: true,
          text: 'â‚¬' + totalFormatted + ' (' + label + ')'
        }
      }
    });
  }

  function uuidv4() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
      var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
      return v.toString(16);
    });
  }

  function onError(evt) {
    writeToScreen('<span style="color: red;">ERROR:</span> ' + evt.data);
  }

  function doSend(message) {
    console.log("SENT: " + message);
    websocket.send(message);
  }

  function writeToScreen(message) {
    let pre = document.createElement("p");
    pre.style.wordWrap = "break-word";
    pre.innerHTML = message;
    output.appendChild(pre);
  }

  window.addEventListener("load", init, false);

  </script>
</head>
<body>
  <div id="output"></div>
</body>
</html>